<?xml version="1.0" encoding="UTF-8"?>
<!-- Phing buildfile -->
<project name="VMTranslator" default="test">
    <!-- Test programs -->
    <fileset dir="tests/functional/StackArithmetic" id="StackArithmetic">
        <include name="SimpleAdd" />
        <include name="StackTest" />
    </fileset>
    <fileset dir="tests/functional/MemoryAccess" id="MemoryAccess">
        <include name="BasicTest" />
        <include name="PointerTest" />
        <include name="StaticTest" />
    </fileset>
    <fileset dir="tests/functional/ProgramFlow" id="ProgramFlow">
        <include name="BasicLoop" />
        <include name="FibonacciSeries" />
    </fileset>
    <fileset dir="tests/functional/FunctionCalls" id="FunctionCalls">
        <include name="SimpleFunction" />
    </fileset>
    <!-- / Test programs -->

    <target name="test" depends="unit,functional" />

    <target name="unit">
        <exec command="phpunit" checkreturn="true" passthru="true" />
    </target>

    <target name="functional">
        <echo msg="Rodando testes funcionais" />
        <foreach param="filename" absparam="absfilename" target="functional.run">
          <fileset refid="StackArithmetic" />
          <fileset refid="MemoryAccess" />
          <!-- <fileset refid="ProgramFlow" /> -->
        </foreach>
    </target>

    <!-- Testar apenas o capitulo 8 -->
    <target name="c8" depends="unit">
        <echo msg="Rodando testes funcionais" />
        <foreach param="filename" absparam="absfilename" target="functional.run">
          <fileset refid="ProgramFlow" />
          <fileset refid="FunctionCalls" />
        </foreach>
    </target>

    <target name="functional.run">
        <property name="program.prefix" value="${absfilename}/${filename}" />
        <echo msg="Translate: ${program.prefix}.vm" />
        <exec command="php VMTranslator.php ${program.prefix}.vm" checkreturn="true" passthru="true" />
        <echo msg="Run: ${program.prefix}.tst" />
        <exec command="CPUEmulator.sh ${program.prefix}.tst" />
        <exec command="TextComparer.sh ${program.prefix}.cmp ${program.prefix}.out" passthru="true" checkreturn="true" />
    </target>

    <target name="clean">
        <delete>
            <fileset dir="tests/functional">
                <include name="**/*.asm" />
                <include name="**/*.out" />
            </fileset>
        </delete>
    </target>
</project>
